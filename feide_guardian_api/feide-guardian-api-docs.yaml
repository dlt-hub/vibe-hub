resources:
- name: guardian_students
  endpoint:
    path: /guardian_students
    method: POST
    data_selector: '[*]'
    params:
      guardian: '21079416549'
      realm: testusers.feide.no
- name: data_source
  endpoint:
    method: POST
    params:
      audience: https://n.feide.no/datasources/{data_source_uuid}
      client_id: '{client_id}'
      client_secret: '{client_secret}'
      scope: '{scope}'
      subject_token: '{subject_token}'
      subject_token_type: urn:ietf:params:oauth:token-type:access_token
- name: userinfo
  endpoint:
    path: /userinfo
    method: GET
- name: extended_userinfo
  endpoint:
    path: /extended_userinfo
    method: GET
- name: groups_api
  endpoint:
    path: /groups_api
    method: GET
- name: metadata
  endpoint:
    path: /saml/metadata
    method: GET
    data_selector: attributes
    params: {}
- name: userinfo
  endpoint:
    path: /userinfo
    method: GET
- name: extended_userinfo
  endpoint:
    path: /extended_userinfo
    method: GET
- name: groups_api
  endpoint:
    path: /groups
    method: GET
- name: organization
  endpoint:
    path: /2/org/all
    method: GET
    data_selector: organizations
    params:
      fields: name,realm,organization_number
- name: school
  endpoint:
    path: /v4/enhet/{organization_number}
    method: GET
    data_selector: ForeldreRelasjoner
    params: {}
- name: ExampleService
  endpoint:
    path: /saml
    method: POST
    data_selector: md:EntityDescriptor
- name: organization
  endpoint:
    path: /2/org/all
    method: GET
    data_selector: organizations
    params:
      fields: name,realm,organization_number
- name: school
  endpoint:
    path: /v4/enhet/{organization_number}
    method: GET
    data_selector: ForeldreRelasjoner
    params: {}
- name: token_exchange
  endpoint:
    path: /oauth/token
    method: POST
    data_selector: access_token
    params: {}
- name: LDAP validator
  endpoint:
    path: /ldap/validator
    method: GET
    data_selector: records
- name: user_data_check
  endpoint:
    path: /customer_portal/view_errors_in_user_directory
    method: GET
- name: ldap_crawler
  endpoint:
    path: /customer_portal/ldap_crawler
    method: GET
- name: userinfo
  endpoint:
    path: /openid/userinfo
    method: GET
    data_selector: claims
- name: LDAP validator
  endpoint:
    path: /ldap/validator
    method: GET
    data_selector: results
- name: userinfo
  endpoint:
    path: /openid/userinfo
    method: GET
    data_selector: claims
- name: UserIDs
  endpoint:
    path: /apis/userinfo
    method: GET
    data_selector: userid
    params: {}
- name: LogoutRequest
  endpoint:
    path: /ssp/saml2/idp/slo.php
    method: POST
- name: LogoutResponse
  endpoint:
    path: /ssp/saml2/sp/slo.php
    method: POST
- name: AuthnRequest
  endpoint:
    path: /ssp/saml2/idp/SSOService.php
    method: GET
- name: AuthnResponse
  endpoint:
    path: /ssp/saml2/sp/acs.php
    method: POST
- name: test_idp_metadata
  endpoint:
    path: /simplesaml/saml2/idp/metadata.php
    method: GET
    data_selector: metadata
    params: {}
- name: logout
  endpoint:
    path: /openid/endsession
    method: GET
- name: test_users
  endpoint:
    path: /testusers.feide.no
    method: GET
    data_selector: users
    params: {}
- name: test_metadata
  endpoint:
    path: /idp/metadata.php
    method: GET
- name: test_idp_metadata
  endpoint:
    path: /idp/metadata.php?output=xhtml
    method: GET
- name: simple_lower_education_users
  endpoint:
    path: /users/lower_education
    method: GET
    data_selector: users
    params: {}
- name: simple_higher_education_users
  endpoint:
    path: /users/higher_education
    method: GET
    data_selector: users
    params: {}
- name: lower_education_users_with_class_info
  endpoint:
    path: /users/lower_education/class_info
    method: GET
    data_selector: users
    params: {}
- name: users
  endpoint:
    path: /feide/test/users
    method: GET
    data_selector: users
- name: preselectOrg
  endpoint:
    path: /preselectOrg.php
    method: GET
    params:
      HomeOrg: realm
      ReturnTo: url
- name: students
  endpoint:
    path: /students
    method: GET
    data_selector: students
    params: {}
- name: teachers
  endpoint:
    path: /teachers
    method: GET
    data_selector: teachers
    params: {}
- name: staff
  endpoint:
    path: /staff
    method: GET
    data_selector: staff
    params: {}
- name: test_users
  endpoint:
    path: /feide/test_users
    method: GET
    data_selector: users
    params: {}
- name: users
  endpoint:
    path: /api/users
    method: GET
    data_selector: users
- name: lower_education_users
  endpoint:
    path: /api/lower_education_users
    method: GET
    data_selector: users
    params: {}
- name: higher_education_users
  endpoint:
    path: /api/higher_education_users
    method: GET
    data_selector: users
    params: {}
- name: lower_education_users_with_classes
  endpoint:
    path: /api/lower_education_users_with_classes
    method: GET
    data_selector: users
    params: {}
- name: students
  endpoint:
    path: /feide/test/users
    method: GET
    data_selector: users
    params: {}
- name: elev
  endpoint:
    path: /feide/test/users
    method: GET
    data_selector: users
    params: {}
- name: test_users
  endpoint:
    path: /feide/test/users
    method: GET
    data_selector: users
    params: {}
- name: users
  endpoint:
    path: /api/users
    method: GET
    data_selector: users
    params: {}
notes:
- This is a proof of concept implementation. It may be changed or discontinued at
  short notice.
- Only the logged in guardian’s own students may be looked up.
- Feide uses OAuth2 for authentication.
- Uses OAuth2 with refresh token — requires setup of connected app in Feide
- As a service provider, users can log in to your service with Feide.
- Feide runs a central login service offering single sign on (SSO)
- All personal data are stored and managed by home organizations
- Feide does not store information about the end users in any way, the institutions
  need to store themselves the relevant information for their own users and the other
  factors they want to support.
- The shared secret is necessary to setup and use an Authenticator application to
  authenticate a user.
- Uses OAuth2 with refresh token — requires setup of connected app in api
- The core login system must support more platforms and devices than our other systems.
- Feide offers OpenID Connect and OAuth 2.0 interfaces towards applications.
- Institutions need to store relevant information for their own users and the other
  factors they want to support.
- Feide does not store information about the end users in any way.
- Feide is a centralized login service, the only organization that your service will
  see in eduGAIN is Feide itself.
- Core login system must support more platforms and devices than other systems.
- SAML metadata is static and must be updated manually in the Feide customer portal.
- To receive information about maintenance and updates to the Feide IDP, you can subscribe
  to the mailing list at feide-updates@lists.sikt.no.
- If the error says ‘This element is not expected’ it is most likely because there
  is an XML element in the wrong place.
- Order is significant in the SAML metadata XML.
- This requires adding SAML metadata for the new domain.
- Feide is a centralized login service.
- As long as you switch to a new certificate issued by a public certificate authority,
  the certificate should already be installed at the Feide login service.
- Feide is an opt-in federation, meaning the organizations that have joined Feide
  need to explicitly approve the use of a service before end users can access it.
- SAML metadata is static and must be updated manually in the Feide customer portal
- End users need to access domains idp.feide.no, auth.dataporten.no, api.dataporten.no,
  groups-api.dataporten.no
- Feide does not modify attributes it sends to services.
- The Feide login system never communicates directly with your service. Instead all
  communication goes through the end user’s web browser. This means that there is
  no need to make any adjustments at Feide’s end when the https-certificate changes.
- Feide does not require signed messages from service providers, and does not encrypt
  messages to the services. The certificate configured in the SAML 2.0 software at
  the service is therefore not used by Feide, and can be updated any time the service
  requires it.
- End users need to access specific domains to log into Feide services.
- It is possible to change the domain, but very painful.
- The domain that is configured for the organization in Feide is used to identify
  the organization in multiple places.
- It is impossible to run with both the old and the new domain during a transition
  period.
- Feide uses the SAML 2.0 protocol.
- Feide requires the use of HTTPS.
- Feide encourages single logout support.
- Cookies used for authentication will have SameSite attribute set to None.
- The Feide login system shows this error if a user has been sent back and forth between
  the service they are logging into and the Feide login system many times in a short
  period of time.
- After several round back and forth in a few seconds, Feide will display the 'redirect
  loop detected' error message.
- It is possible, but very painful.
- All SAML applications, and any OpenID Connect applications that use the form_post
  response mode may be affected.
- The Feide login system shows the error 'redirect loop detected' if a user is sent
  back and forth between the service they are logging into and the Feide login system
  many times in a short period of time.
- The organization can control which login methods the organization’s end users will
  be able to choose on Feide’s login window.
- Disabling Feide directory authentication removes Feide’s username and password fields
  from Feide’s login window.
- It may take up to 10 minutes before the login with a Microsoft account is available
  as an option in the organization Feide’s login window.
- Activation of Feide login with the ID-porten is done in Feide’s customer portal.
- It may take up to 10 minutes before the login with ID-porten is available as an
  option in the organization Feide’s login window.
- Upgrading to the latest version of Feide makes it possible to enable services that
  are integrated with OAuth2 / OpenID Connect and not just services that are integrated
  with the SAML protocol.
- Ad hoc groups can be shared across all applications connected to Feide through OIDC/OAuth
- Users must have a Feide account at the organization to log in with an external login
  provider.
- Only enable login providers that the organization’s users can use.
- All users in Norwegian education should choose Login for host organizations in the
  customer portal and use Feide to login to the portal.
- For users without a Feide account, choose Login for service providers to login to
  the portal.
- 'Feide supports two different authentication protocols: SAML 2.0 and OpenID Connect/OAuth.'
- Some services only need a single configuration, while others may need separate configurations
  for each organization with access to the service.
- Activating services for individual schools is only applicable for organizations
  from the lower education sector.
- Make sure that the organization numbers are correct before activating services for
  individual schools.
- Test users are enabled for specific configurations in the customer portal.
- Users in Norwegian education should choose Login for host organizations in the customer
  portal and use Feide to login to the portal.
- This document describes how services can ask Feide to initiate MFA and how to verify
  that MFA was used.
- When a service is published, the organizations that should have access must be granted
  access.
- The response will contain an error if the user has no way of using MFA.
- 'The service will need to send the following parameter as part of the authentication
  request: acr_values=urn:mace:feide.no:auth:level:fad08:3'
- After authentication, the acr field in the generated ID token should be used to
  verify the authentication level.
- Standard test users can be used for testing the login process.
- A JWT cannot be reliably revoked. Therefore, the lifetime is only 5 minutes.
- Access to the legacy API gatekeeper could only be managed through Dataporten Dashboard,
  which is no longer available.
- The service should check the eduPersonAssurance attribute in the response to verify
  the authentication level.
- An error will occur if the user has no way of using MFA.
- 'When using OAuth/OpenID Connect the service will need to send the following parameter
  as part of the authentication request: acr_values=urn:mace:feide.no:auth:level:fad08:3'
- Requires registration of the application in the Feide Customer Portal
- Use HTTPS secured endpoints for production
- A JWT cannot be reliably revoked.
- The lifetime of a JWT is 5 minutes.
- Best current practice is to use authorization code flow with PKCE.
- The native app must be reachable locally at a URL.
- Requests without an X-Dataporten-userid header are system requests obtained using
  client credentials flow.
- One of the methods that can be used to authenticate users in Feide is the SAML 2.0
  protocol.
- The SAML 2.0 standard is large and covers many different use cases.
- More OpenID Connect details are available on the official documentation.
- There is no guarantee that organizations delete user accounts when they are no longer
  in use.
- Use TLS, and validate the certificates on all endpoints.
- To limit the consequences of security breaches, only request attribute groups that
  you actually need.
- The longterm scope lasts two years, and should not be used if the information protected
  is sensitive or valuable.
- Prefer OIDC over OAuth2 with the legacy Feide userinfo endpoint.
- Feide is connected to eduGAIN, enabling login for users from other federations
- Development allows unsecured redirect_uri endpoints, production requires HTTPS secured
  endpoints
- Feide is connected to eduGAIN and uses the same protocol as other organizations
  connected to eduGAIN (SAML 2.0)
- Organizations must activate the service before users can log in using Feide
- Institution must explicitly agree to accept eduGAIN connectivity before users are
  allowed to login through a given institution.
- Service Providers must perform a technical test using the Feide Test Environment.
- Add the `system-all-users` scope to your service.
- Feide operates a single SAML 2.0 identity provider that represents all organizations.
- If no organizations have activated your service, your service will not be added
  to the Feide login system.
- Data owner approval must be obtained outside of the Customer Portal.
- Public data source may be made internal at any time after creation.
- Feide operates a single Identity Provider on behalf of educational and research
  institutions in Norway.
- Institution must explicitly agree to accept eduGAIN connectivity before users are
  allowed to login.
- Only the data provider will be able to manage such access in the Customer Portal.
- If set to Requires approval the service needs approval from the data owner.
- If set to Free access the access will be granted automatically when requested.
- The service/API must validate the access token.
- The token is only valid if the current time is in the interval between the 'iat'
  and 'exp' timestamps.
- The token lifetime is 5 minutes. If the data source needs access after the token
  has expired, it must obtain a new one.
- Uses JWT tokens for authentication
- Accessing data using JWT Token Exchange
- In order to be shown under 'All data sources' and get requests from services for
  access, the data source needs to be set to Public.
- Setting the data source to Public can be done under the Visibility tab when editing
  the data source.
- Feide requires LDAP servers to support TLS version 1.2.
- TLS 1.1, TLS 1.0, SSL version 3.0 and older is not supported by Feide.
- The service/API must validate the access token. In particular, `iss` has to be `https://auth.dataporten.no`
  and `aud` has to match the ID of the corresponding, registered data source prefixed
  by `https://n.feide.no/datasources/`.
- Validator checks user directories for common problems and errors.
- The LDAP validator runs checks of user data during login.
- Full checks can be run using the LDAP crawler from the customer portal.
- The service needs to be using OIDC for integrating with Feide.
- Institutions can configure which services should use multifactor authentication
  in Feide’s Customer Portal
- Attribute norEduPersonAuthnMethod must contain the fixed string 'urn:mace:feide.no:auth:method:azuread
  -'
- MFA is successful if 'acr' is '1' and 'amr' contains 'mfa'
- On Windows Server 2008 R2, TLS version 1.2 must be enabled.
- Feide requires LDAP servers to support at least one of the specified cipher suites.
- Feide requires LDAP servers to be configured with a certificate issued from a public
  certificate provider.
- Requires multifactor authentication setup.
- In Feide we have a LDAP validator.
- This validator checks user directories for common problems and errors.
- 'The following are valid phone numbers to be used with SMS authentication: +4701234567,
  +34012345678, +10123456789'
- 'The following are NOT valid phone numbers to be used with SMS authentication: 004701234567,
  4701234567, +470123456, +47 01 23 45 67, +1-012-345-6789'
- 'The following are valid secrets to be used with the Authenticator method: ABCDEFGHIJ234567,
  MKMPIDBZ2UOUSCTZ, ABCDEFGHIJKLMNOP, 2345672345672345'
- 'The following are NOT valid secrets to be used with the Authenticator method: abcdefghijklmnop,
  0123456789012345, 0123456789, 234567ABC, ABCDEFGHIJKLMNOPQRSTUVWXYZ, ABC +=1234567DEF'
- Clients must present a valid access token to retrieve the userinfo claims.
- Feide handles both primary and secondary userIDs
- Applications should consider multiple secondary userIDs of the same type
- Dynamic registration is not supported.
- 'Implicit grant flow response_mode: id_token token is also still supported but should
  be avoided for new clients.'
- Institutions must configure which services should use multifactor authentication
  in Feide’s Customer Portal.
- For OpenID Connect applications, the end session endpoint is https://auth.dataporten.no/openid/endsession.
- For legacy applications, it is https://auth.dataporten.no/logout.
- Institutions can enable multifactor authentication based on Entra ID if the Entra
  ID login method has been enabled in the Customer Portal.
- A norEduPersonAuthnMethod attribute needs to be added to every user who should be
  able to use this mechanism.
- 'This attribute is multivalued and MUST contain the following fixed string identifying
  the Entra ID multifactor method in Feide: urn:mace:feide.no:auth:method:azuread
  -'
- This indicates that the user has had their identity verified and that the multifactor
  authentication method has been provisioned to the user securely.
- 'When we authenticate a Feide user using Entra ID we validate the following claims
  of the access token: acr must be the value 1 and amr must contain the value mfa.'
- SAML 2.0 support available
- Feide configuration is based on the Interoperable SAML 2.0 Profile and recommendations
  for single logout (SLO).
- It is recommended to use pre-made SAML handling libraries for major web development
  platforms.
- 'The following are valid phone numbers to be used with SMS authentication: +4701234567,
  +34012345678, +10123456789.'
- 'The following are valid secrets to be used with the Authenticator method: ABCDEFGHIJ234567,
  MKMPIDBZ2UOUSCTZ, ABCDEFGHIJKLMNOP, 2345672345672345.'
- Uses SAML for authentication.
- SAML messages are transported through the user’s web browser.
- Feide with OIDC/OAuth is not locked down to operate on only one kind of user identifier.
- Each user record is issued a unique opaque primary UserID, and a set of secondary
  userIDs of various kinds.
- Feide operates both a test IdP and a production IdP.
- The application can request a specific authentication level via the optional acr_values
  parameter.
- Service Providers MUST support HTTPS on all the SAML URLs used to communicate with
  Feide.
- Service Providers MUST send Logout Requests to Feide when a user initiates logout.
- The organization set with this method will override any organization choice made
  by the user.
- Even when the organization selects the organization using this method, the user
  is still able to override it.
- SAML 2.0 integration requires proper setup of user attributes.
- An opaque ASCII string used to access APIs provided by Feide and third party data
  sources using the legacy API gatekeeper.
- JWT tokens consist of a header, a payload and a signature, with a . between them.
- Uses HTTP-redirect and HTTP-POST bindings for SAML messages.
- SAML messages are encrypted in the communication channel.
- Service Providers MUST support the use of the HTTP Redirect or the HTTP POST bindings
  for sending Authentication Requests to Feide.
- Service Providers MUST support the HTTP POST binding for receiving Authentication
  Responses from Feide.
- These users can use MFA through authenticator codes from https://totp.danhersam.com/
- These users are affiliated with multiple schools, thus their information spans several
  rows.
- 'All test users have the same password: 098asd.'
errors:
- '401 Unauthorized: Invalid credentials or token expired.'
- The user is not allowed access to the system.
- The user is missing an attribute the service requires.
- 'Metadata not found: If no organizations have activated your service'
- '400 Bad Request: Check the request parameters.'
- '401 Unauthorized: Ensure credentials are correct.'
- '403 Forbidden: Verify that the service is allowed to access the requested resource.'
- 'Metadata not found: Users will receive this error if no organizations have activated
  your service.'
- '401 Unauthorized: Recheck OAuth scopes or token expiration'
- Ensure TLS version 1.2 is enabled on Windows Server 2008 R2.
- 'INVALID_CLIENT: Check client ID and secret.'
- 'INVALID_GRANT: Verify the authorization code or refresh token.'
- '401 Unauthorized: Ensure proper permissions for user attributes'
- 'REQUEST_LIMIT_EXCEEDED: Throttle API calls or reduce frequency'
- 'QUERY_TIMEOUT: Break down filters or add selectivity'
- 'urn:oasis:names:tc:SAML:2.0:status:Success: Indicates successful authentication.'
- 'urn:oasis:names:tc:SAML:2.0:status:Failure: Indicates unsuccessful authentication.'
auth_info:
  mentioned_objects:
  - Access Token
  - Authorization Code Grant
  - Implicit Grant
  - Client Credentials Grant
  - eduPersonPrincipalName
  - schacHomeOrganization
  - eduPersonScopedAffiliation
  - norEduPersonAuthnMethod
client:
  base_url: https://auth.dataporten.no
  auth:
    type: oauth2
    flow: authorization_code
    token_url: https://auth.dataporten.no/oauth/token
    client_id: '{{ dlt.secrets[''client_id''] }}'
    client_secret: '{{ dlt.secrets[''client_secret''] }}'
    location: header
    header_name: Authorization
source_metadata: null
